const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.join(__dirname, 'workout_tracker.db');
const db = new sqlite3.Database(dbPath);

// Initialize database tables
db.serialize(() => {
    // Bruker (User profile) table
    db.run(`CREATE TABLE IF NOT EXISTS bruker (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        vekt REAL NOT NULL,
        hoyde INTEGER NOT NULL,
        alder INTEGER,
        kjonn TEXT CHECK(kjonn IN ('mann', 'kvinne')),
        aktivitetsniva TEXT CHECK(aktivitetsniva IN ('lav', 'moderat', 'hoy')),
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // Kondisjon (Cardio) table
    db.run(`CREATE TABLE IF NOT EXISTS kondisjon (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        dato DATE NOT NULL,
        km REAL NOT NULL,
        tid_minutter INTEGER NOT NULL,
        snittpuls INTEGER,
        hoydemeter REAL,
        stigningsprosent REAL,
        kalorier INTEGER,
        kommentar TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // Styrke (Strength) tables
    db.run(`CREATE TABLE IF NOT EXISTS styrke_aktiviteter (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        navn TEXT NOT NULL UNIQUE,
        beskrivelse TEXT,
        maks_vekt REAL DEFAULT 0,
        maks_vekt_dato DATE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // Styrke trenings√∏kter (workout sessions)
    db.run(`CREATE TABLE IF NOT EXISTS styrke_okter (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        dato DATE NOT NULL,
        navn TEXT,
        kommentar TEXT,
        kalorier INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // Individuelle √∏velser i en trenings√∏kt
    db.run(`CREATE TABLE IF NOT EXISTS styrke_ovelser (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        okt_id INTEGER NOT NULL,
        aktivitet_id INTEGER NOT NULL,
        sett INTEGER NOT NULL,
        reps INTEGER NOT NULL,
        vekt REAL NOT NULL,
        tid_minutter INTEGER,
        kommentar TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (okt_id) REFERENCES styrke_okter (id) ON DELETE CASCADE,
        FOREIGN KEY (aktivitet_id) REFERENCES styrke_aktiviteter (id)
    )`);

    db.run(`CREATE TABLE IF NOT EXISTS styrke_rekorder (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        aktivitet_id INTEGER NOT NULL,
        vekt REAL NOT NULL,
        reps INTEGER NOT NULL,
        dato DATE NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (aktivitet_id) REFERENCES styrke_aktiviteter (id)
    )`);

    // Lagidrett (Team Sports) table
    db.run(`CREATE TABLE IF NOT EXISTS lagidrett (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        sport TEXT NOT NULL,
        dato DATE NOT NULL,
        tid_minutter INTEGER NOT NULL,
        snittpuls INTEGER,
        makspuls INTEGER,
        kalorier INTEGER,
        kommentar TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // Kondisjon rekorder table (forbedret)
    db.run(`CREATE TABLE IF NOT EXISTS kondisjon_rekorder (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        distanse_km REAL NOT NULL,
        beste_tid_minutter INTEGER NOT NULL,
        tempo_per_km REAL NOT NULL,
        okt_id INTEGER,
        dato DATE NOT NULL,
        automatisk BOOLEAN DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (okt_id) REFERENCES kondisjon (id)
    )`);
    
    // Legg til indeks for raskere s√∏k
    db.run(`CREATE INDEX IF NOT EXISTS idx_kondisjon_rekorder_distanse ON kondisjon_rekorder (distanse_km)`);
    db.run(`CREATE INDEX IF NOT EXISTS idx_kondisjon_distanse ON kondisjon (km)`);
    db.run(`CREATE INDEX IF NOT EXISTS idx_kondisjon_tid ON kondisjon (tid_minutter)`);
    
    // Bruker profil table
    db.run(`CREATE TABLE IF NOT EXISTS bruker (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        vekt REAL NOT NULL,
        hoyde INTEGER NOT NULL,
        alder INTEGER,
        kjonn TEXT,
        aktivitetsniva TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // M√•l (Goals) table
    db.run(`CREATE TABLE IF NOT EXISTS mal (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        type TEXT NOT NULL,
        beskrivelse TEXT,
        maal_verdi REAL NOT NULL,
        nuvaerende_verdi REAL DEFAULT 0,
        enhet TEXT NOT NULL,
        frist DATE NOT NULL,
        status TEXT DEFAULT 'aktiv',
        aktivitet_detaljer TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        oppnadd_at DATETIME
    )`);

    // Badges table
    db.run(`CREATE TABLE IF NOT EXISTS badges (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        navn TEXT NOT NULL UNIQUE,
        beskrivelse TEXT NOT NULL,
        type TEXT NOT NULL,
        kriterium TEXT NOT NULL,
        ikon TEXT DEFAULT 'üèÜ',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // Bruker badges (oppn√•dde badges)
    db.run(`CREATE TABLE IF NOT EXISTS bruker_badges (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        badge_id INTEGER NOT NULL,
        oppnadd_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        detaljer TEXT,
        FOREIGN KEY (badge_id) REFERENCES badges (id)
    )`);

    // Legg til standard badges
    const standardBadges = [
        // F√∏rste gang badges
        ['F√∏rste L√∏p', 'Fullf√∏rt din f√∏rste kondisjonstrening', 'kondisjon', 'first_kondisjon', 'üèÉ'],
        ['F√∏rste Styrke', 'Fullf√∏rt din f√∏rste styrketrening', 'styrke', 'first_styrke', 'üí™'],
        ['F√∏rste Lagidrett', 'Fullf√∏rt din f√∏rste lagidrettstrening', 'lagidrett', 'first_lagidrett', '‚öΩ'],
        
        // Frekvens og strekk badges
        ['Uke Strekk', 'Trent 7 dager p√• rad', 'frekvens', 'streak_7', 'üî•'],
        ['To Uker Strekk', 'Trent 14 dager p√• rad', 'frekvens', 'streak_14', 'üî•üî•'],
        ['M√•ned Strekk', 'Trent 30 dager p√• rad', 'frekvens', 'streak_30', 'üî•üî•üî•'],
        ['Uke Kriger', 'Trent 5 ganger p√• en uke', 'frekvens', 'week_5', '‚öîÔ∏è'],
        ['Helg Kriger', 'Trent i helgen 5 ganger', 'frekvens', 'weekend_5', 'üõ°Ô∏è'],
        
        // Kondisjon avstands badges
        ['5K Nybegynner', 'L√∏pt totalt 5 km', 'kondisjon', 'total_5k', 'ü•â'],
        ['10K Mester', 'L√∏pt totalt 10 km', 'kondisjon', 'total_10k', 'üéØ'],
        ['Halvmaraton', 'L√∏pt totalt 21 km', 'kondisjon', 'total_21k', 'üèÉ‚Äç‚ôÇÔ∏è'],
        ['50K Mester', 'L√∏pt totalt 50 km', 'kondisjon', 'total_50k', 'üèÜ'],
        ['100K Mester', 'L√∏pt totalt 100 km', 'kondisjon', 'total_100k', 'üëë'],
        ['Maraton Konge', 'L√∏pt totalt 200 km', 'kondisjon', 'total_200k', 'üî±'],
        ['Ultra L√∏per', 'L√∏pt totalt 500 km', 'kondisjon', 'total_500k', 'üåü'],
        
        // Kondisjon tempo badges
        ['Tempo Mester', 'L√∏pt under 5:00 min/km', 'kondisjon', 'tempo_5min', '‚ö°'],
        ['Racer', 'L√∏pt under 4:30 min/km', 'kondisjon', 'tempo_430', 'üèéÔ∏è'],
        ['Sprinter', 'L√∏pt under 4:00 min/km', 'kondisjon', 'tempo_4min', 'üí®'],
        ['Usain Bolt', 'L√∏pt under 3:30 min/km', 'kondisjon', 'tempo_330', 'üöÄ'],
        
        // Kondisjon enkelt √∏kter
        ['5K Enkel', 'L√∏pt 5 km i en √∏kt', 'kondisjon', 'single_5k', 'üéñÔ∏è'],
        ['10K Enkel', 'L√∏pt 10 km i en √∏kt', 'kondisjon', 'single_10k', 'üèÖ'],
        ['15K Enkel', 'L√∏pt 15 km i en √∏kt', 'kondisjon', 'single_15k', 'ü•á'],
        ['Halvmaraton Enkelt', 'L√∏pt 21 km i en √∏kt', 'kondisjon', 'single_21k', 'üëë'],
        
        // Styrke badges
        ['Styrke Veteran', '50 styrketreninger fullf√∏rt', 'styrke', 'styrke_50', 'üèãÔ∏è'],
        ['Styrke Mester', '100 styrketreninger fullf√∏rt', 'styrke', 'styrke_100', 'üèãÔ∏è‚Äç‚ôÇÔ∏è'],
        ['Styrke Gud', '200 styrketreninger fullf√∏rt', 'styrke', 'styrke_200', 'ü¶ç'],
        ['Vekt L√∏fter', 'L√∏ftet totalt 1000 kg', 'styrke', 'total_1000kg', 'üèóÔ∏è'],
        ['Kraftpakke', 'L√∏ftet totalt 5000 kg', 'styrke', 'total_5000kg', 'ü¶è'],
        ['Styrke Titan', 'L√∏ftet totalt 10000 kg', 'styrke', 'total_10000kg', 'üóø'],
        ['Sett Samler', 'Fullf√∏rt 500 sett', 'styrke', 'sets_500', 'üìä'],
        ['Rep Mester', 'Fullf√∏rt 5000 repetisjoner', 'styrke', 'reps_5000', 'üî¢'],
        
        // Lagidrett badges
        ['Sport Entusiast', '10 lagidrett √∏kter fullf√∏rt', 'lagidrett', 'lagidrett_10', 'üèà'],
        ['Lagspiller', '25 lagidrett √∏kter fullf√∏rt', 'lagidrett', 'lagidrett_25', 'üèê'],
        ['Sport Mester', '50 lagidrett √∏kter fullf√∏rt', 'lagidrett', 'lagidrett_50', 'üèÄ'],
        ['Allsidig Atlet', 'Pr√∏vd 3 forskjellige sporter', 'lagidrett', 'sports_3', 'üéæ'],
        ['Sport Samler', 'Pr√∏vd 5 forskjellige sporter', 'lagidrett', 'sports_5', '‚õ≥'],
        
        // Kalori badges
        ['Kalori Starter', 'Forbrent 1,000 kalorier totalt', 'kalorier', 'kalorier_1k', 'üî•'],
        ['Kalori Brenner', 'Forbrent 10,000 kalorier totalt', 'kalorier', 'kalorier_10k', 'üî•üî•'],
        ['Kalori Maskin', 'Forbrent 25,000 kalorier totalt', 'kalorier', 'kalorier_25k', 'üî•üî•üî•'],
        ['Kalori Inferno', 'Forbrent 50,000 kalorier totalt', 'kalorier', 'kalorier_50k', 'üåã'],
        ['Kalori St√∏vsuger', 'Forbrent 100,000 kalorier totalt', 'kalorier', 'kalorier_100k', '‚ö°üî•'],
        ['Mega Forbrenning', 'Forbrent 1000+ kalorier i en √∏kt', 'kalorier', 'single_1000cal', 'üí•'],
        
        // Rekord og progresjon badges
        ['PR Jeger', 'Satt 10 personlige rekorder', 'rekord', 'pr_10', 'üìà'],
        ['Rekord Breaker', 'Satt 25 personlige rekorder', 'rekord', 'pr_25', 'üìä'],
        ['Progresjon Mester', 'Satt 50 personlige rekorder', 'rekord', 'pr_50', 'üöÄ'],
        
        // Tid og varighet badges
        ['Tidtaker', 'Trent totalt 10 timer', 'tid', 'time_10h', '‚è∞'],
        ['Maraton Tid', 'Trent totalt 50 timer', 'tid', 'time_50h', '‚è≤Ô∏è'],
        ['Tid Mester', 'Trent totalt 100 timer', 'tid', 'time_100h', 'üï∞Ô∏è'],
        ['Tid Gud', 'Trent totalt 200 timer', 'tid', 'time_200h', '‚åö'],
        ['Lang √òkt', 'Trent 2+ timer i en √∏kt', 'tid', 'long_2h', 'üèÉ‚Äç‚ôÄÔ∏è'],
        ['Ultra √òkt', 'Trent 3+ timer i en √∏kt', 'tid', 'long_3h', 'üèÉ‚Äç‚ôÇÔ∏èüí®'],
        
        // Spesielle badges
        ['Morgenfugl', 'Trent f√∏r 07:00 - 10 ganger', 'spesiell', 'morning_10', 'üåÖ'],
        ['Nattugle', 'Trent etter 22:00 - 10 ganger', 'spesiell', 'night_10', 'ü¶â'],
        ['Regn Kriger', 'Trent utend√∏rs i d√•rlig v√¶r', 'spesiell', 'rain_warrior', 'üåßÔ∏è'],
        ['P√•skehare', 'Trent p√• p√•skedag', 'spesiell', 'easter', 'üê∞'],
        ['Julenisse', 'Trent p√• julaften', 'spesiell', 'christmas', 'üéÖ'],
        ['Nytt√•rs Helt', 'Trent p√• nytt√•rsdag', 'spesiell', 'newyear', 'üéä'],
        ['Konsistent', 'Trent samme dag i uken 10 ganger', 'spesiell', 'consistent_10', 'üìÖ'],
        ['Allsidig', 'Alle tre treningstyper samme uke', 'spesiell', 'all_types_week', 'üéØ'],
        
        // Motivasjons badges
        ['Comeback Kid', 'Trent etter 30 dagers pause', 'motivasjon', 'comeback_30', 'üí™‚ú®'],
        ['Dedikert', 'Trent 100 ganger totalt', 'motivasjon', 'sessions_100', 'üéñÔ∏è'],
        ['Livsstil', 'Trent 365 ganger totalt', 'motivasjon', 'sessions_365', 'üèÜüëë'],
        ['Inspirasjon', 'Trent 500 ganger totalt', 'motivasjon', 'sessions_500', 'üåüÔøΩ']
    ];

    const insertBadge = db.prepare(`INSERT OR IGNORE INTO badges (navn, beskrivelse, type, kriterium, ikon) VALUES (?, ?, ?, ?, ?)`);
    standardBadges.forEach(badge => {
        insertBadge.run(badge);
    });
    insertBadge.finalize();
    
    // Migrasjon: Legg til nye kolonner hvis de ikke finnes
    db.run(`ALTER TABLE kondisjon ADD COLUMN kalorier INTEGER`, (err) => {
        if (err && !err.message.includes('duplicate column')) {
            console.error('Feil ved tillegg av kalorier kolonne til kondisjon:', err.message);
        }
    });
    
    db.run(`ALTER TABLE styrke_okter ADD COLUMN kalorier INTEGER`, (err) => {
        if (err && !err.message.includes('duplicate column')) {
            console.error('Feil ved tillegg av kalorier kolonne til styrke_okter:', err.message);
        }
    });
    
    db.run(`ALTER TABLE styrke_aktiviteter ADD COLUMN maks_vekt REAL DEFAULT 0`, (err) => {
        if (err && !err.message.includes('duplicate column')) {
            console.error('Feil ved tillegg av maks_vekt kolonne:', err.message);
        }
    });
    
    db.run(`ALTER TABLE styrke_aktiviteter ADD COLUMN maks_vekt_dato DATE`, (err) => {
        if (err && !err.message.includes('duplicate column')) {
            console.error('Feil ved tillegg av maks_vekt_dato kolonne:', err.message);
        }
    });
    
    db.run(`ALTER TABLE styrke_ovelser ADD COLUMN tid_minutter INTEGER`, (err) => {
        if (err && !err.message.includes('duplicate column')) {
            console.error('Feil ved tillegg av tid_minutter kolonne:', err.message);
        }
    });
});

module.exports = db;
